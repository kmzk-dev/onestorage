<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初期設定 - ONE STORAGE (シンプルダミー)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .setting-step { 
            display: none; 
            padding: 15px; 
            border-left: 3px solid #0d6efd; 
            margin-top: 15px;
        }
        .is-active { display: block; }
        .setup-status-list li { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px;
            font-weight: 500;
        }
        .status-icon { width: 20px; text-align: center; }
        .step-description { margin-bottom: 10px; font-size: 0.95rem; color: #555; }
        .step-title-display { font-size: 1.25rem; font-weight: 600; margin-bottom: 15px; }
    </style>
</head>

<body class="bg-white">

    <div class="container my-3">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="p-1">
                    <div class="col-4 mx-auto">
                        <img class="img-fluid" src="img/Gemini_Generated_Image_dpkroidpkroidpkr.png" alt="">
                    </div>
                    <p class="text-center text-muted">あなただけのストレージサービスを開始します。</p>
        
                    
                    <div class="mb-3 p-3">
                        <span class="mb-3"><i class="fa-solid fa-clipboard-list me-2"></i>設定の進捗</span>
                        <hr>
                        <div class="p-2 bg-light">
                                                    <ul class="list-unstyled setup-status-list">
                            <li id="li-storage-data">
                                <span id="statusIconStorageData" class="status-icon me-2"></span> 
                                ストレージの設定
                            </li>
                            <li id="li-storage-accept">
                                <span id="statusIconStorageAccept" class="status-icon me-2"></span> 
                                利用できる拡張子の設定
                            </li>
                            <li id="li-account">
                                <span id="statusIconAccount" class="status-icon me-2"></span> 
                                アカウント登録
                            </li>
                            <li id="li-mfa">
                                <span id="statusIconMfa" class="status-icon me-2"></span> 
                                二段階認証（MFA）キー登録
                            </li>
                        </ul>


                        </div>
                    </div>
                    
                    <div id="stepArea">
                         <div id="stepTitle" class="step-title-display text-primary"></div>
                         <div id="errorMessage" class="alert alert-danger d-none"></div>

                        <div id="stepStorageData" class="setting-step">
                            <p class="step-description">システムが動作するための設定ファイル（config.php, cookie_key.php）を作成します。データフォルダは既に作成済みです。</p>
                            <button id="btnCreateStorageData" class="btn btn-primary">設定を完了 (ダミー)</button>
                        </div>

                        <div id="stepStorageAccept" class="setting-step">
                            <p class="step-description">アップロードを許可するファイル拡張子リスト(config/accept.json)を作成します。</p>
                            <button id="btnOpenAcceptModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#acceptModal">拡張子を設定</button>
                        </div>
                        
                        <div id="stepAccount" class="setting-step">
                            <p class="step-description">管理者としてログインするためのメールアドレスとパスワードを設定します。</p>
                            <button id="btnOpenAccountModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#accountModal">アカウントを登録</button>
                        </div>
                        
                        <div id="stepMfa" class="setting-step">
                            <p class="step-description">Google Authenticator連携用のシークレットキーを生成・表示します。アプリへの登録が必要です。</p>
                            <button id="btnOpenMfaModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mfaModal">MFAキーを生成・表示</button>
                        </div>
                        
                        <div id="stepComplete" class="setting-step text-center py-4 border-0">
                            <h4 class="mb-4 text-success"><i class="fa-solid fa-circle-check me-2"></i>すべての設定が完了しました</h4>
                            <a href="#" id="btnLogin" class="btn btn-lg btn-primary" disabled>ログイン (ダミー)</a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="acceptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ステップ2: 利用できる拡張子の設定</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formAcceptExtensions">
                    <div class="modal-body">
                        <div class="mb-4">
                            <label class="form-label fw-bold">ファイルサイズ上限 (MB):</label>
                            <input type="number" id="maxFileSize" name="maxFileSize" class="form-control" value="500" min="1" required>
                        </div>
                        <label class="form-label fw-bold">許可する拡張子:</label>
                        <div class="row">
                            <script>
                                const default_extensions = ['pdf', 'txt', 'csv', 'md', 'jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'mp3', 'mp4', 'zip', 'xls', 'xlsx', 'doc', 'docx', 'pptx', 'heic'];
                                const chunks = [];
                                const chunkSize = Math.ceil(default_extensions.length / 3);
                                for (let i = 0; i < default_extensions.length; i += chunkSize) {
                                    chunks.push(default_extensions.slice(i, i + chunkSize));
                                }
                                document.write(chunks.map(chunk => `
                                    <div class="col-4">
                                        ${chunk.map(ext => `
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="extensions[]" value="${ext}" id="ext_${ext}" checked>
                                                <label class="form-check-label" for="ext_${ext}">.${ext}</label>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join(''));
                            </script>
                        </div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button><button type="submit" class="btn btn-primary" id="btnSaveAccept">設定を保存 (ダミー)</button></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="accountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ステップ3: 管理者アカウント登録</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formRegisterAccount">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="user" class="form-label fw-bold">メールアドレス:</label> 
                            <input type="email" id="modalUser" name="user" class="form-control" value="demo@onestorage.local" required>
                        </div>
                        <div class="mb-4">
                            <label for="password" class="form-label fw-bold">パスワード:</label>
                            <input type="password" id="modalPassword" name="password" class="form-control" autocomplete="new-password" required>
                            <div class="form-text">大文字/小文字/数字を含む15桁以上で設定してください。</div>
                        </div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button><button type="submit" class="btn btn-primary" id="btnRegisterAccount">アカウントを登録 (ダミー)</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="mfaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ステップ4: 二段階認証（MFA）キー登録</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted small">Google Authenticatorアプリで以下のQRコードをスキャンするか、セットアップコードを手動入力してください。</p>
                    
                    <div id="mfaQrcodeContainer" class="mb-4">
                         <img id="mfaQrcodeImage" src="" alt="MFA QR Code" class="img-fluid border p-2 bg-light" style="width: 200px; height: 200px;">
                    </div>
                    
                    <h6 class="fw-bold">セットアップコード:</h6>
                    <div class="mb-4 p-3 bg-light border text-center">
                        <h4 class="text-break mb-0 font-monospace text-primary" id="mfaSecretDisplay">キーを生成してください</h4>
                    </div>
                    
                    <h6 class="mt-4 fw-bold">手動登録手順:</h6>
                    <ol class="small text-start">
                        <li>Google Authenticatorアプリを開きます。</li>
                        <li>「設定キーを入力」を選択します。</li>
                        <li>アカウント名に「One Storage」など任意の名前を入力します。</li>
                        <li>キーに上記セットアップコードを入力し、「時間ベース」を選択して保存します。</li>
                    </ol>

                </div>
                <div class="modal-footer"><button type="button" class="btn btn-success w-100" data-bs-dismiss="modal" id="btnMfaNext">MFA登録を完了し、次へ (ダミー)</button></div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- ダミーデータ/初期状態 ---
        let setupStatus = {
            'storage_data': false, 
            'storage_accept': false, 
            'account': false, 
            'mfa': false 
        };
        
        const CURRENT_USER_EMAIL = 'demo@onestorage.local';
        const DUMMY_MFA_SECRET = 'JBSWY3DPEHPK3PXP'; 
        const DUMMY_QR_URL = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=otpauth%3A%2F%2Ftotp%2FOne%20Storage%3Ademo%40onestorage.local%3Fsecret%3DJBSWY3DPEHPK3PXP%26issuer%3DOne%20Storage';


        // --- UI要素 ---
        const STEPS = ['storage_data', 'storage_accept', 'account', 'mfa'];
        const STEP_DIVS = {
            'storage_data': 'stepStorageData',
            'storage_accept': 'stepStorageAccept',
            'account': 'stepAccount',
            'mfa': 'stepMfa'
        };
        const STATUS_ICONS = {
            'pending': '<i class="fa-solid fa-circle-xmark text-danger"></i>',
            'in_progress': '<i class="fa-solid fa-spinner fa-spin-pulse text-info"></i>',
            'completed': '<i class="fa-solid fa-circle-check text-success"></i>',
        };

        // アイコン要素を正しく取得するように修正
        const statusElements = {
            'storage_data': document.getElementById('statusIconStorageData'),
            'storage_accept': document.getElementById('statusIconStorageAccept'),
            'account': document.getElementById('statusIconAccount'),
            'mfa': document.getElementById('statusIconMfa')
        };
        const errorMessageDiv = document.getElementById('errorMessage');
        const btnLogin = document.getElementById('btnLogin');
        const acceptModal = new bootstrap.Modal(document.getElementById('acceptModal'));
        const accountModal = new bootstrap.Modal(document.getElementById('accountModal'));
        const mfaModal = new bootstrap.Modal(document.getElementById('mfaModal'));
        const stepTitleEl = document.getElementById('stepTitle');


        // --- UIヘルパー関数 ---

        function updateStatusDisplay() {
            for (const key of STEPS) {
                const iconEl = statusElements[key];
                if (!iconEl) continue;

                if (setupStatus[key]) {
                    iconEl.innerHTML = STATUS_ICONS.completed;
                } else {
                    iconEl.innerHTML = STATUS_ICONS.pending;
                }
            }
        }

        function showStep(stepKey) {
            document.querySelectorAll('.setting-step').forEach(div => div.classList.remove('is-active'));
            const targetDivId = STEP_DIVS[stepKey] || 'stepComplete';
            const targetDiv = document.getElementById(targetDivId);
            
            const stepIndex = STEPS.indexOf(stepKey);
            
            if (stepKey === 'complete') {
                stepTitleEl.textContent = 'すべての設定が完了しました';
            } else {
                // li要素のテキスト全体からステップ名を設定
                const listItem = document.getElementById(`li-${stepKey}`);
                const stepName = listItem ? listItem.textContent.trim().replace(/.*\s/, '') : '設定';
                stepTitleEl.textContent = `ステップ ${stepIndex + 1}: ${stepName}`;
            }
            
            if (targetDiv) {
                targetDiv.classList.add('is-active');
            }
        }
        
        function showError(message) {
            errorMessageDiv.textContent = 'エラー: ' + message;
            errorMessageDiv.classList.remove('d-none');
        }
        
        function hideError() {
            errorMessageDiv.classList.add('d-none');
        }
        
        function setButtonLoading(button, isLoading) {
            const originalText = button.dataset.originalText || button.textContent;
            if (isLoading) {
                button.dataset.originalText = originalText;
                button.disabled = true;
                button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 処理中...`;
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function findNextStep() {
            for (const step of STEPS) {
                if (!setupStatus[step]) {
                    return step;
                }
            }
            return 'complete';
        }

        function advanceSetup() {
            updateStatusDisplay();
            hideError();
            const nextStep = findNextStep();
            
            if (nextStep === 'complete') {
                showStep('complete');
                finalizeSetup();
            } else {
                showStep(nextStep);
            }
        }

        // --- ダミーAPIロジック ---
        function finalizeSetup() {
            // ダミー成功
            btnLogin.disabled = false;
            btnLogin.textContent = 'ログイン (ダミー)';
            setTimeout(() => {
                // 実際はlogin.phpへ遷移
            }, 1000); 
        }

        // --- イベントリスナー ---

        // Step 1: 基本設定ファイル作成 (ダミー処理)
        document.getElementById('btnCreateStorageData').addEventListener('click', async function() {
            setButtonLoading(this, true);
            await new Promise(r => setTimeout(r, 800)); 
            
            setButtonLoading(this, false);
            setupStatus.storage_data = true;
            advanceSetup();
        });

        // Step 2: 拡張子設定 モーダル内の保存ボタン (ダミー処理)
        document.getElementById('formAcceptExtensions').addEventListener('submit', async function(e) {
            e.preventDefault();
            const button = document.getElementById('btnSaveAccept');
            setButtonLoading(button, true);
            
            await new Promise(r => setTimeout(r, 800));
            
            setButtonLoading(button, false);
            acceptModal.hide();
            setupStatus.storage_accept = true;
            advanceSetup();
        });
        
        // Step 3: アカウント登録 モーダル内の登録ボタン (ダミー処理)
        document.getElementById('formRegisterAccount').addEventListener('submit', async function(e) {
            e.preventDefault();
            const button = document.getElementById('btnRegisterAccount');
            setButtonLoading(button, true);
            
            await new Promise(r => setTimeout(r, 800));
            
            setButtonLoading(button, false);
            accountModal.hide();
            setupStatus.account = true;
            advanceSetup();
        });

        // Step 4: MFAキー生成 モーダルを開く前にAPIをコール (ダミー処理)
        document.getElementById('btnOpenMfaModal').addEventListener('click', async function() {
            setButtonLoading(this, true);
            hideError();
            
            await new Promise(r => setTimeout(r, 800));
            
            setButtonLoading(this, false);
            
            // UIの更新 (ダミーデータを使用)
            document.getElementById('mfaSecretDisplay').textContent = DUMMY_MFA_SECRET;
            document.getElementById('mfaQrcodeImage').src = DUMMY_QR_URL;
            
            // モーダル表示
            mfaModal.show();
        });
        
        // Step 4: MFA登録完了 モーダル内の完了ボタン (ダミー処理)
        document.getElementById('btnMfaNext').addEventListener('click', function() {
            setupStatus.mfa = true;
            advanceSetup();
        });


        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            advanceSetup();
        });
    </script>
</body>

</html>